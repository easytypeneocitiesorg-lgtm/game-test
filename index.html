<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cube Encounter Game</title>
  <style>
    body { margin:0; background:black; color:white; font-family:sans-serif; }
    canvas { display:block; margin:0 auto; background:black; }
    #ui { text-align:center; margin-top:10px; }
    button { margin:5px; padding:10px 20px; font-size:16px; }
    button:disabled {
      background-color: #555;
      color: #aaa;
      cursor: not-allowed;
    }
    .floatText {
      position: relative;
      color: red;
      font-weight: bold;
      animation: floatUp 1.5s ease-out forwards;
    }
    @keyframes floatUp {
      from { top:0; opacity:1; }
      to { top:-30px; opacity:0; }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <div id="ui" style="display:none;">
    <p id="playerHealth"></p>
    <p id="enemyHealth"></p>
    <button id="attackBtn">Attack</button>
    <button id="healBtn">Heal</button>
    <button id="restartBtn" style="display:none;">Restart</button>
    <p id="message"></p>
    <div id="floatLayer"></div>
  </div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let player, enemyCube, keys, inEncounter, enemy, healUses, cooldown;

function initGame() {
  player = { x:50, y:50, size:30, color:"blue", health:36, maxHealth:50 };
  enemyCube = { x: Math.random()*550, y: Math.random()*350, size:30, color:"red" };
  keys = {};
  inEncounter = false;
  enemy = null;
  healUses = 3;
  cooldown = false;
  document.getElementById("ui").style.display = "none";
  document.getElementById("attackBtn").disabled = false;
  document.getElementById("healBtn").disabled = false;
  document.getElementById("restartBtn").style.display = "none";
}
initGame();

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

function update() {
  if (!inEncounter) {
    if (keys["ArrowUp"] || keys["w"]) player.y -= 3;
    if (keys["ArrowDown"] || keys["s"]) player.y += 3;
    if (keys["ArrowLeft"] || keys["a"]) player.x -= 3;
    if (keys["ArrowRight"] || keys["d"]) player.x += 3;

    if (player.x < enemyCube.x + enemyCube.size &&
        player.x + player.size > enemyCube.x &&
        player.y < enemyCube.y + enemyCube.size &&
        player.y + player.size > enemyCube.y) {
          startEncounter();
    }
  }
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!inEncounter) {
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.size, player.size);
    ctx.fillStyle = enemyCube.color;
    ctx.fillRect(enemyCube.x, enemyCube.y, enemyCube.size, enemyCube.size);
  }
}

function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}
gameLoop();

function startEncounter() {
  inEncounter = true;
  enemy = { health: Math.floor(Math.random()*36)+20 }; // 20–55
  document.getElementById("ui").style.display = "block";
  updateUI("Encounter started!");
}

function updateUI(msg="") {
  document.getElementById("playerHealth").textContent = "Player HP: " + player.health;
  document.getElementById("enemyHealth").textContent = "Enemy HP: " + enemy.health;
  document.getElementById("message").textContent = msg;
}

function playSound() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioCtx.createOscillator();
  oscillator.type = "square";
  oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
  oscillator.connect(audioCtx.destination);
  oscillator.start();
  oscillator.stop(audioCtx.currentTime + 0.2);
}

function showFloatText(text) {
  const floatLayer = document.getElementById("floatLayer");
  const el = document.createElement("div");
  el.className = "floatText";
  el.textContent = text;
  floatLayer.appendChild(el);
  setTimeout(()=>floatLayer.removeChild(el),1500);
}

function setCooldown(state) {
  cooldown = state;
  document.getElementById("attackBtn").disabled = state;
  document.getElementById("healBtn").disabled = state;
}

document.getElementById("attackBtn").onclick = () => {
  if (cooldown) return;
  setCooldown(true);
  let dmg = Math.floor(Math.random()*5)+3; // 3–7
  showFloatText("-"+dmg);
  playSound();
  setTimeout(()=>{
    enemy.health -= dmg;
    updateUI("You attacked!");
    if (enemy.health <= 0) {
      endEncounter(false);
    } else {
      enemyTurn(); // enemy only starts after damage applied
    }
  },1500);
};

document.getElementById("healBtn").onclick = () => {
  if (cooldown) return;
  if (healUses > 0) {
    setCooldown(true);
    let heal = Math.floor(Math.random()*6)+5; // 5–10
    showFloatText("+"+heal);
    playSound();
    setTimeout(()=>{
      player.health = Math.min(player.maxHealth, player.health+heal);
      healUses--;
      updateUI("You healed!");
      enemyTurn(); // enemy only starts after heal applied
    },1500);
  } else {
    updateUI("No heals left!");
  }
};

function enemyTurn() {
  setTimeout(()=>{
    let dmg = Math.floor(Math.random()*8)+4; // 4–11
    showFloatText("-"+dmg);
    playSound();
    setTimeout(()=>{
      player.health -= dmg;
      if (player.health <= 0) {
        endEncounter(true);
      } else {
        updateUI("Enemy attacked!");
        setCooldown(false); // unlock only after enemy damage applied
      }
    },1500);
  },2000);
}

function endEncounter(playerDefeated=false) {
  if (playerDefeated) {
    updateUI("Game Over!");
    document.getElementById("attackBtn").disabled = true;
    document.getElementById("healBtn").disabled = true;
    document.getElementById("restartBtn").style.display = "inline-block";
  } else {
    updateUI("Victory!");
    setCooldown(false); // unlock immediately on victory
  }
}

document.getElementById("restartBtn").onclick = () => {
  initGame();
};
</script>
</body>
</html>
